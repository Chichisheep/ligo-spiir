#!/usr/bin/env python
#
# Copyright (C) 2017  Qi Chu
#
# This program is free software; you can redistribute it and/or modify it
# under the terms of the GNU General Public License as published by the
# Free Software Foundation; either version 2 of the License, or (at your
# option) any later version.
#
# This program is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General
# Public License for more details.
#
# You should have received a copy of the GNU General Public License along
# with this program; if not, write to the Free Software Foundation, Inc.,
# 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.


import numpy
from optparse import OptionParser
from gstlal.cbc_template_iir import matched_filt
import pdb

import matplotlib
matplotlib.use('Agg')

from matplotlib import pyplot




parser = OptionParser(description = __doc__)

parser.add_option("--template-fname", metavar = "filename", help = "Set the filename in which to save the template bank (required).")
parser.add_option("--data-fname", metavar = "filename", help = "Set the filename in which to save the data (required).")
parser.add_option("--sampleRate", metavar = "Hz", type = "float", default = 4096.0, help = "Set the sample rate of the IIR template bank (optional).")

options, filenames = parser.parse_args()

template = numpy.loadtxt(options.template_fname).view(complex)
time, data = numpy.loadtxt(options.data_fname, usecols = (0,1), unpack = True)

snr_time, sigma = matched_filt(template, data, sampleRate = options.sampleRate)
#pdb.set_trace()
print max(abs(snr_time)), sigma
pyplot.figure()
p1 = pyplot.plot(abs(snr_time))
pyplot.savefig('snr_series.svg', format = "svg", dpi = 1200)
