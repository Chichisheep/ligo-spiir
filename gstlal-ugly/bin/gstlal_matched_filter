#!/usr/bin/env python
#
# Copyright (C) 2017  Qi Chu
#
# This program is free software; you can redistribute it and/or modify it
# under the terms of the GNU General Public License as published by the
# Free Software Foundation; either version 2 of the License, or (at your
# option) any later version.
#
# This program is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General
# Public License for more details.
#
# You should have received a copy of the GNU General Public License along
# with this program; if not, write to the Free Software Foundation, Inc.,
# 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.


import numpy
from optparse import OptionParser
from gstlal.cbc_template_iir import matched_filt
import pdb

import matplotlib
matplotlib.use('Agg')
from matplotlib import pyplot




parser = OptionParser(description = __doc__)

parser.add_option("--template-fname", metavar = "filename", help = "Set the filename in which to save the template bank (required).")
parser.add_option("--data-fname", metavar = "filename", help = "Set the filename in which to save the data (required).")
parser.add_option("--sampleRate", metavar = "Hz", type = "float", default = 4096.0, help = "Set the sample rate of the IIR template bank (optional).")
parser.add_option("--snr-prefix", metavar = "filename", default = None, help = "Set the filename in which to save the snr series plot, if not set, will not store the plot and snr txt series.")
parser.add_option("-v", "--verbose", action = "store_true", help = "Be verbose (optional).")
options, filenames = parser.parse_args()

template = numpy.loadtxt(options.template_fname).view(complex)
data = numpy.loadtxt(options.data_fname, usecols = (0,1)) # gps_time, value
snr, sigma, indmax, timemax = matched_filt(template, data, sampleRate = options.sampleRate)
if options.verbose:
	print "max snr is %f, sigma %f, indmax %f, timemax %f" % (max(abs(snr)), sigma, indmax, timemax)

if options.snr_prefix:
	pyplot.figure()
	p1 = pyplot.plot(data[:,0] - timemax, snr[0:len(data[:,0])])
	pyplot.xlabel("Time since {0:.4f}".format(timemax))
	pyplot.savefig("%s.svg" % options.snr_prefix, format = "svg", dpi = 1200)
	numpy.savetxt("%s.txt" % options.snr_prefix, snr.view(float))

