#!/usr/bin/python
import sys
import os


# S5 began on 815155213 - Fri Nov 04 16:00:00 GMT 2005
# S5 ended on 875232014 - Mon Oct 01 00:00:00 GMT 2007
# This program returns the GPS boundaries that approximately correspond to commissioning breaks during this time starting with 815504413 - Tues Nov 08 12:00:00 EST 2005

if len(sys.argv) != 3:
	print >>sys.stderr, "usage %s <week (int)> <path to bank dir>" % (sys.argv[0],)
	sys.exit()

week = int(sys.argv[1])
path = os.path.abspath(sys.argv[2])

if week < 1 or week > 98:
	print >>sys.stderr, "week must be between 1 and 98"
	sys.exit(1)

start = 815504413 + (week - 1) * 604800
end = 815504413 + (week) * 604800

print >>sys.stderr, "\n\tmaking directory for week spanning ", start, end

dir = "%d-%d" % (start, end)
os.mkdir("%d-%d" % (start, end))

f = open("%s/Makefile" % (dir,) , "w")
f.write("START = %d\n" % (start,))
f.write("STOP = %d\n" % (end,))
f.write("PSD_FILE = %s/reference_psd.xml.gz\n" % (path,))
f.write("H1_BANK_CACHE = %s/mode_H1-TMPLTBANK-869040003-2048_svd_bank.cache\n" % (path,))
f.write("H2_BANK_CACHE = %s/mode_H2-TMPLTBANK-875211248-2048_svd_bank.cache\n" % (path,))
f.write("L1_BANK_CACHE = %s/mode_L1-TMPLTBANK-858087370-2048_svd_bank.cache\n" % (path,))
f.write("SEED = %d\n" % (week,))
f.write("""
MIN_DIST = 100
MAX_DIST = 10000
MIN_MASS = 0.2
MAX_MASS = 1.0
MIN_TOTAL_MASS = $(shell echo 2 \* $(MIN_MASS) | bc)
MAX_TOTAL_MASS = $(shell echo 2 \* $(MAX_MASS) | bc)
FLOW = 39
TRIM = 16

all : injections

tisi.xml :
	ligolw_tisi --instrument=H1=0:0:0 --instrument=H2=0:0:0 --instrument=L1=0:3.14159:3.14159 tisi.xml

dag : vetoes.xml segments.xml frame.cache tisi.xml
	gstlal_s5_pbh_trigger_pipe --gps-start-time $(START) --gps-stop-time $(STOP) --reference-psd $(PSD_FILE) --frame-cache frame.cache --frame-segments-file segments.xml  --frame-segments-name RESULT --bank-cache H1=$(H1_BANK_CACHE),H2=$(H2_BANK_CACHE),L1=$(L1_BANK_CACHE) --vetoes vetoes.xml --time-slide-file tisi.xml

injections : vetoes.xml segments.xml frame.cache injections.xml
	gstlal_s5_pbh_trigger_pipe --injections injections.xml --gps-start-time $(START) --gps-stop-time $(STOP) --reference-psd $(PSD_FILE) --frame-cache frame.cache --frame-segments-file segments.xml --frame-segments-name RESULT --bank-cache H1=$(H1_BANK_CACHE),H2=$(H2_BANK_CACHE),L1=$(L1_BANK_CACHE) --vetoes vetoes.xml

H1vetoes.xml:
	ligolw_segment_query --segment-url=https://metaserver.phy.syr.edu -q --gps-start-time ${START} --gps-end-time ${STOP} --include-segments=H1:Injection --result-name=vetoes > H1vetoes.xml
	ligolw_segments_compat H1vetoes.xml

H2vetoes.xml:
	ligolw_segment_query --segment-url=https://metaserver.phy.syr.edu -q --gps-start-time ${START} --gps-end-time ${STOP} --include-segments=H2:Injection --result-name=vetoes > H2vetoes.xml
	ligolw_segments_compat H2vetoes.xml

L1vetoes.xml:
	ligolw_segment_query --segment-url=https://metaserver.phy.syr.edu -q --gps-start-time ${START} --gps-end-time ${STOP} --include-segments=L1:Injection --result-name=vetoes > L1vetoes.xml
	ligolw_segments_compat L1vetoes.xml

H1segmentspadded.xml:
	ligolw_segment_query --segment-url=https://metaserver.phy.syr.edu -q --gps-start-time ${START} --gps-end-time ${STOP} --include-segments=H1:Science  > H1segments.xml
	ligolw_segments_compat H1segments.xml
	gstlal_s5_pbh_segments_trim H1segments.xml $(TRIM) H1segmentspadded.xml

H2segmentspadded.xml:
	ligolw_segment_query --segment-url=https://metaserver.phy.syr.edu -q --gps-start-time ${START} --gps-end-time ${STOP} --include-segments=H2:Science > H2segments.xml
	ligolw_segments_compat H2segments.xml
	gstlal_s5_pbh_segments_trim H2segments.xml $(TRIM) H2segmentspadded.xml

L1segmentspadded.xml:
	ligolw_segment_query --segment-url=https://metaserver.phy.syr.edu -q --gps-start-time ${START} --gps-end-time ${STOP} --include-segments=L1:Science > L1segments.xml
	ligolw_segments_compat L1segments.xml
	gstlal_s5_pbh_segments_trim L1segments.xml $(TRIM) L1segmentspadded.xml

vetoes.xml: H1vetoes.xml H2vetoes.xml L1vetoes.xml
	ligolw_add H1vetoes.xml H2vetoes.xml L1vetoes.xml > vetoes.xml

frame.H1.cache:
	ligo_data_find -o H -t H1_RDS_C03_L2 -l  -s $(START) -e $(STOP) --url-type file > frame.H1.cache

frame.H2.cache:
	ligo_data_find -o H -t H2_RDS_C03_L2 -l  -s $(START) -e $(STOP) --url-type file > frame.H2.cache

frame.L1.cache:
	ligo_data_find -o L -t L1_RDS_C03_L2 -l  -s $(START) -e $(STOP) --url-type file > frame.L1.cache

frame.cache: frame.H1.cache frame.H2.cache frame.L1.cache
	cat frame.H1.cache frame.H2.cache frame.L1.cache > frame.cache

segments.xml: H1segmentspadded.xml H2segmentspadded.xml L1segmentspadded.xml
	ligolw_add --output segments.xml H1segmentspadded.xml H2segmentspadded.xml L1segmentspadded.xml

injections.xml:
	lalapps_inspinj \\
		--output injections.xml \\
		--seed $(SEED) \\
		--f-lower $(FLOW) \\
		--gps-start-time $(START) \\
		--gps-end-time $(STOP) \\
		--t-distr uniform \\
		--time-step 100 \\
		--time-interval 20 \\
		--i-distr uniform \\
		--l-distr random \\
		--d-distr log10 \\
		--min-distance $(MIN_DIST) \\
		--max-distance $(MAX_DIST) \\
		--m-distr componentMass \\
		--min-mass1 $(MIN_MASS) \\
		--max-mass1 $(MAX_MASS) \\
		--min-mass2 $(MIN_MASS) \\
		--max-mass2 $(MAX_MASS) \\
		--min-mtotal $(MIN_TOTAL_MASS) \\
		--max-mtotal $(MAX_TOTAL_MASS) \\
		--waveform GeneratePPNtwoPN \\
		--taper-injection start \\
		--disable-spin

realclean :
	rm -r *.sub *.dag* *.cache *.sh logs *.xml
""")
f.close()

print >>sys.stderr, "\n\tcd into %s and run make.  Then do condor_submit_dag -maxidle 100 trigger_pipe.dag\n" % (dir,)
